var swdapi=swdapi||function(g,w){function l(x,y){return typeof x!=="undefined"?x:y}if(!Date.now){Date.now=function(){return new Date().getTime()}}w=l(w,{});if(XMLHttpRequest===undefined){throw"SWDAPI: Required component 'XMLHttpRequest' not defined."}if(Date.now===undefined){throw"SWDAPI: Required component 'Date.now' not defined."}if(Number.isInteger===undefined){throw"SWDAPI: Required component 'Number.isInteger' not defined."}if(console.log===undefined){throw"SWDAPI: Required component 'console.log' not defined."}if(forge_sha256===undefined){throw"SWDAPI: Required component 'forge_sha256' not defined. Did you forget to include it?"}var c=g,j=0,f=null,e=(typeof w.fetchClientData==="function"?w.fetchClientData:d),p=(typeof w.storeClientData==="function"?w.storeClientData:h),r={login:m,logout:v,getAuthToken:o,request:a,serverDate:k,registerClient:n,setFetchClientDataHandler:function(x){if(typeof x==="function"){e=x;return true}throw"Could not store fetchClientData handler. Not a callable function."},setStoreClientDataHandler:function(x){if(typeof x==="function"){p=x;return true}throw"Could not store storeClientData handler. Not a callable function."}};if(w.setClientName!==undefined&&typeof w.setClientName==="string"){var b=e();if(typeof b!=="object"||b.name===undefined||b.name!==w.setClientName.substring(0,140)){n(w.setClientName)}}if(w.serverTimestamp!==undefined){if(Number.isInteger(w.serverTimestamp)===true){u(w.serverTimestamp*1000)}else{console.log("Supplied serverTimestamp was an invalid format. Must be positive integer. The server time will be noted on the next request instead.")}}return r;function s(C,A,z){var B={},y=k().getTime(),x=e();if(x.id!==undefined&&x.secret!==undefined){B.client={id:x.id}}if(z!==null&&z.id!==undefined&&z.uid!==undefined){B.token={id:z.id,uid:z.uid}}B.nonce=(Math.random().toString(36)+"00000000000000000").slice(2,10+2);B.valid={from:Math.floor(y/1000)-(60),to:Math.floor(y/1000)+(60)};B.signature=q(C,B,A,z);return B}function q(E,C,B,z){var D,A,y,x=e();D=JSON.stringify([E,C,B]);A="swdapi";if(C.client!==undefined&&C.client.id!==undefined&&x.secret!==undefined){A+=x.id+x.secret}if(C.token!==undefined&&z.id!==undefined&&z.secret!==undefined){A+=z.id+z.secret}y=forge_sha256(D+A);return y}function m(x,y,z){z=l(z,null);o(x,y,function(A){if(typeof A=="object"){f=A}if(typeof z==="function"){z(A)}})}function v(z){var y,x=f;z=l(z,null);y=function(A){if(A===true){console.log("Logout completed")}else{console.log("Logout failed.");f=x}if(typeof z==="function"){z(A)}};if(f!==null){console.log("Requesting logout.");a("swdapi/invalidateAuthToken",{id:f.id},y,y,f);f=null}else{console.log("logout called when not logged in.");if(typeof z==="function"){z(false)}}}function o(z,F,G,D,y){var E,A,C,x;G=l(G,null);D=l(D,null);y=l(y,null);if(z===undefined||typeof z!=="string"){throw"The user ID you specified is invalid. It must be a non-empty string."}if(z.length<3){throw"The user ID you specified is too short"}if(F===undefined||typeof F!=="string"){throw"The password you specified is invalid. It must be a non-empty string."}if(F.length<5){throw"The password you specified is too short"}if(D!==null&&(!(typeof D==="number"&&(D%1)===0)||D<=k().now())){throw"The expiry you requested for your user session is not a number or is in the past."}if(y!==null&&(!(typeof D==="number"&&(D%1)===0)||y<=1)){throw"The requestTimeout you requested for your user session is not a number or is less than one."}E=e();if(typeof E!=="object"||E.id===undefined||typeof E.id!=="string"||E.secret===undefined||typeof E.secret!=="string"){throw"You cannot request an AuthToken without having a valid client to assign the token to."}var B=(Math.random().toString(36)+"00000000000000000").slice(2,10+2);A={user:z,pass:F,clientID:E.id,requestExpiry:D,requestTimeout:y,salt:B,signature:forge_sha256(JSON.stringify([z,F,D,y,B,E.id,E.secret]))};C=function(H){var I=forge_sha256(JSON.stringify([H.token,B,E.secret]));if(I!==H.signature){throw"Error in returned auth token. Signature is invalid."}if(typeof G==="function"){G(H.token)}};x=function(H){if(typeof G==="function"){G(H)}else{throw H}};a("swdapi/getAuthToken",A,C,x,null)}function t(x){if(x===undefined||typeof x!=="object"){console.log("Invalid token: must be object");return false}if(x.id===undefined||Number.isInteger(x.id)===false||x.id<0){console.log("Invalid token: id must be defined and be a non-zero integar");return false}if(x.clientID===undefined||Number.isInteger(x.clientID)===false||x.clientID<0){console.log("Invalid token: clientID must be defined and be a non-zero integar");return false}if(x.uid===undefined||typeof x.uid!=="string"||x.uid.length<1){console.log("Invalid token: uid must be defined and be a non-empty string");return false}if(x.secret===undefined||typeof x.secret!=="string"||x.secret.length!==64){console.log("Invalid token: secret must be defined and be a string (64)");return false}if(x.expires===undefined||Number.isInteger(x.expires)===false||x.expires<1){console.log("Invalid token: expires must be defined and be a non-zero integar");return false}if(x.timeout===undefined||Number.isInteger(x.timeout)===false||x.timeout<1){console.log("Invalid token: timeout must be defined and be a non-zero integar");return false}return true}function n(z,B){z=l(z,null);B=l(B,null);var A=e(),x={salt:(Math.random().toString(36)+"00000000000000000").slice(2,10+2)},y;if(typeof A==="object"&&A.id!==undefined){x.id=A.id}if(typeof A==="object"&&A.id!==undefined&&A.secret!==undefined){x.signature=forge_sha256("swdapi"+A.id+A.secret)}if(typeof z==="string"){x.name=z.substring(0,140)}else{if(z!==null){throw"Cannot register client. Argument 1 must be either a string or null."}else{if(typeof A==="object"&&A.name!==undefined){x.name=A.name.substring(0,140)}else{throw"Cannot register a client without a name. No name is stored and no name was passed to registerClient()"}}}y=function(E){if(typeof E!=="object"||E.id===undefined||E.name===undefined){throw"Could not confirm registration of the client. An unexpected error occured."}var D={name:E.name,id:E.id,},C;if(A.id!==undefined&&A.secret!==undefined){D.secret=A.secret;C=forge_sha256("swdapi"+x.salt+x.id+A.secret);if(E.signature===undefined||C!==E.signature){throw"Failed to confirm the client id. The signature returned by the server doesn't match ours. This should be impossible without a man in the middle."}}else{if(E.secret!==undefined){D.secret=E.secret}}p(D);console.log("New client registered successfully: "+D.name);if(typeof B==="function"){B()}};console.log("Registering client with server.");a("swdapi/registerClient",x,y,function(C){if(typeof C!=="object"||C["SWDAPI-Error"]===undefined||!(C["SWDAPI-Error"].code===400014||C["SWDAPI-Error"].code===403002||C["SWDAPI-Error"].code===403004)){throw"Could not register the client. An unexpected error occured."}console.log("The client id-secret pair stored on this device has either expired or is corrupt. Requesting a new one.");delete A.id;delete A.secret;p({name:x.name,});delete x.id;delete x.signature;a("swdapi/registerClient",x,null,y,function(){throw"Could not register the client. An unexpected error occured."})})}function d(){if(!i("localStorage")){throw"Unable to access localStorage API. You must define your own fetchClientData and storeClientData handlers."}var x={};if(window.localStorage.getItem("client-id")!==null){x.id=window.localStorage.getItem("client-id")}if(window.localStorage.getItem("client-secret")!==null){x.secret=window.localStorage.getItem("client-secret")}if(window.localStorage.getItem("client-name")!==null){x.name=window.localStorage.getItem("client-name")}return x}function h(x){if(!i("localStorage")){throw"Unable to access localStorage API. You must define your own fetchClientData and storeClientData handlers."}if(x.id!==undefined){window.localStorage.setItem("client-id",x.id)}else{window.localStorage.removeItem("client-id")}if(x.secret!==undefined){window.localStorage.setItem("client-secret",x.secret)}else{window.localStorage.removeItem("client-secret")}if(x.name!==undefined){window.localStorage.setItem("client-name",x.name)}else{window.localStorage.removeItem("client-name")}return true}function i(z){try{var B=window[z],y="__storage_test__";B.setItem(y,y);B.removeItem(y);return true}catch(A){return false}}function a(E,B,y,D,A){A=l(A,f);y=l(y,null);D=l(D,null);var z=new XMLHttpRequest(),C=null,x=5;if(A!==null&&t(A)!==true){throw"The authentication token you passed is in an invalid format. Request not sent."}C=s(E,B,A);z.open("POST",c);z.setRequestHeader("Content-Type","application/json;charset=UTF-8");z.onreadystatechange=function(){if(z.readyState!==z.DONE){return}var F=(z.getResponseHeader("content-type")==="application/json"?JSON.parse(z.responseText):z.responseText);if(z.status===200){if(typeof y==="function"){y(F,E,B,z)}return true}x-=1;if(typeof F!=="string"&&F["SWDAPI-Error"]!==undefined&&F["SWDAPI-Error"]["code"]!==undefined){var G=F["SWDAPI-Error"]["code"];if(G>=400006&&G<=400009){console.log("Request failed due to expiry data. Reseting system time offset and trying again.");u(z.getResponseHeader("date"))}else{if(G==400014||G==403002){console.log("SWDAPI: An api request failed because the server reported that the request's signature was invalid. This could be because the client id-secret pair you are using is invalid or has expired, the authentication token you are using has expired or is invalid or some other secret information embeded in the signature has changed on the server.Please contact support. Clearing you browser cache and localStorage container will fix this problem but will require you to reauthenticate.");x=0}else{x=0}}}else{x=0}if(x>0){a(E,B,y,D,A);return true}if(typeof D==="function"){D(F,E,B,A,z)}else{throw [F,E,B,A,z]}};z.send(JSON.stringify({method:E,meta:C,data:B}));return true}function u(y){var z=new Date(y),x=z.getTime()-Date.now();console.log("Stored server clock offset: "+x+"ms (previously "+j+"ms)");j=x}function k(){return new Date(Date.now()+j)}};
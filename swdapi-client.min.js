var swdapi=swdapi||{};swdapi.client=swdapi.client||function(m,F){function s(G,H){return typeof G!=="undefined"?G:H}if(!Date.now){Date.now=function(){return new Date().getTime()}}F=s(F,{});if(typeof JSON==="undefined"){throw"SWDAPI: Required component 'JSON' not defined. Please include an external JSON library."}if(typeof XMLHttpRequest==="undefined"){throw"SWDAPI: Required component 'XMLHttpRequest' not defined."}if(typeof jsSHA==="undefined"){throw"SWDAPI: Required component 'jsSHA' not defined. Did you forget to include it?"}Number.isInteger=Number.isInteger||function(G){return typeof G==="number"&&isFinite(G)&&Math.floor(G)===G};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(G){var H=this.length>>>0;var I=Number(arguments[1])||0;I=(I<0)?Math.ceil(I):Math.floor(I);if(I<0){I+=H}for(;I<H;I++){if(I in this&&this[I]===G){return I}}return -1}}if(typeof window.console==="undefined"){window.console={}}if(typeof console.log==="undefined"){console.log=function(){}}var g=m,q=0,l=null,e,v={defaultToken:[]},C=(typeof F.autoReregister==="boolean"?F.autoReregister:true),k=(typeof F.fetchClientData==="function"?F.fetchClientData:i),x=(typeof F.storeClientData==="function"?F.storeClientData:o),z={login:t,logout:E,getAuthToken:w,setDefaultToken:b,validateAuthToken:a,request:d,serverDate:r,registerClient:u,addListener:n,removeListener:h,setFetchClientDataHandler:function(G){if(typeof G==="function"){k=G;return true}throw"Could not store fetchClientData handler. Not a callable function."},setStoreClientDataHandler:function(G){if(typeof G==="function"){x=G;return true}throw"Could not store storeClientData handler. Not a callable function."}};if(F.setClientName!==undefined&&typeof F.setClientName==="string"){var f=k();if(typeof f!=="object"||f.name===undefined||f.name!==F.setClientName.substring(0,140)||f.secret===undefined||f.id===undefined){u(F.setClientName)}}else{if(F.defaultClientName!==undefined&&typeof F.defaultClientName==="string"){e=F.defaultClientName;var f=k();if(typeof f!=="object"||f.name===undefined||f.secret===undefined||f.id===undefined){u()}}}if(F.serverTimestamp!==undefined){if(Number.isInteger(F.serverTimestamp)===true){D(F.serverTimestamp*1000)}else{console.log("Supplied serverTimestamp was an invalid format. Must be positive integer. The server time will be noted on the next request instead.")}}return z;function B(L,J,I){var K={},H=r().getTime(),G=k();if(G.id!==undefined&&G.secret!==undefined){K.client={id:G.id}}if(I!==null&&I.id!==undefined&&I.uid!==undefined){K.token={id:I.id,uid:I.uid}}K.nonce=j();K.valid={from:Math.floor(H/1000)-(60),to:Math.floor(H/1000)+(60)};K.signature=y(L,K,J,I);return K}function y(G,O,K,I){var M,L,N,H=k();M=JSON.stringify([G,O,K]);L="swdapi";if(O.client!==undefined&&O.client.id!==undefined&&H.secret!==undefined){L+=H.id+H.secret}if(O.token!==undefined&&I.id!==undefined&&I.secret!==undefined){L+=I.id+I.secret}var J=new jsSHA("SHA-256","TEXT");J.update(M+L);N=J.getHash("HEX");return N}function t(G,H,J,I){J=s(J,null);w(G,H,function(K){if(K!==null&&typeof K=="object"&&"type" in K&&K.type==="SWDAPI-AuthToken"){l=b(K)}if(typeof J==="function"){J(K)}},I)}function E(H){var G;H=s(H,null);G=function(I){if(I===true){console.log("Logout completed");l=b(null)}else{console.log("Logout failed.")}if(typeof H==="function"){H(I)}};if(l!==null){console.log("Requesting logout.");d("swdapi/invalidateAuthToken",{id:l.id},G,G,l)}else{console.log("logout called when not logged in.");if(typeof H==="function"){H(false)}}}function w(I,Q,R,J,O,H){var P,K,N,G;R=s(R,null);J=s(J,null);O=s(O,null);H=s(H,null);if(I===undefined||typeof I!=="string"){throw"The user ID you specified is invalid. It must be a non-empty string."}if(I.length<3){throw"The user ID you specified is too short"}if(Q===undefined||typeof Q!=="string"){throw"The password you specified is invalid. It must be a non-empty string."}if(Q.length<5){throw"The password you specified is too short"}if(O!==null&&(!(typeof O==="number"&&(O%1)===0)||O<=r().now())){throw"The expiry you requested for your user session is not a number or is in the past."}if(H!==null&&(!(typeof O==="number"&&(O%1)===0)||H<=1)){throw"The requestTimeout you requested for your user session is not a number or is less than one."}P=k();if(typeof P!=="object"||P.id===undefined||typeof P.id!=="string"||P.secret===undefined||typeof P.secret!=="string"){throw"You cannot request an AuthToken without having a valid client to assign the token to."}var L=j();K={user:I,pass:Q,clientID:P.id,requestPermissions:J,requestExpiry:O,requestTimeout:H,salt:L};var M=new jsSHA("SHA-256","TEXT");M.update(JSON.stringify([I,Q,J,O,H,L,P.id,P.secret]));K.signature=M.getHash("HEX");N=function(T){var S=new jsSHA("SHA-256","TEXT");S.update(JSON.stringify([T.token,L,P.secret]));var U=S.getHash("HEX");if(U!==T.signature){throw"Error in returned auth token. Signature is invalid."}console.log("Successfully authenticated as "+I);if(typeof R==="function"){R(T.token)}};G=function(S){console.log("Could not authenticate as "+I);if(typeof R==="function"){R(S)}else{throw S}};d("swdapi/getAuthToken",K,N,G,null)}function b(G){if(G===null||A(G)){l=G;c("defaultToken",G);return G}return false}function a(G,H){s(G,l);if(!A(G)){H(false);return false}return d("swdapi/validateAuthToken",null,function(){H(true)},function(I){H(I)},G)}function A(G){if(G===undefined||G===null||typeof G!=="object"){console.log("Invalid token: must be object");return false}if(!("type" in G)||typeof G.type!=="string"||G.type!=="SWDAPI-AuthToken"){console.log("Invalid token: Doesn't contain valid type definition.");return false}if(G.id===undefined||Number.isInteger(G.id)===false||G.id<0){console.log("Invalid token: id must be defined and be a non-zero integar");return false}if(G.clientID===undefined||Number.isInteger(G.clientID)===false||G.clientID<0){console.log("Invalid token: clientID must be defined and be a non-zero integar");return false}if(G.uid===undefined||typeof G.uid!=="string"||G.uid.length<1){console.log("Invalid token: uid must be defined and be a non-empty string");return false}if(G.secret===undefined||typeof G.secret!=="string"||G.secret.length!==64){console.log("Invalid token: secret must be defined and be a string (64)");return false}if(G.expires===undefined||Number.isInteger(G.expires)===false||G.expires<1){console.log("Invalid token: expires must be defined and be a non-zero integar");return false}if(G.timeout===undefined||Number.isInteger(G.timeout)===false||G.timeout<1){console.log("Invalid token: timeout must be defined and be a non-zero integar");return false}return true}function u(J,L){J=s(J,null);L=s(L,null);var K=k(),G={salt:j()},I;if(typeof K==="object"&&K.id!==undefined){G.id=K.id}if(typeof K==="object"&&K.id!==undefined&&K.secret!==undefined){var H=new jsSHA("SHA-256","TEXT");H.update("swdapi"+K.id+K.secret);G.signature=H.getHash("HEX")}if(typeof J==="string"){G.name=J.substring(0,140)}else{if(J!==null){throw"Cannot register client. Argument 1 must be either a string or null."}else{if(typeof K==="object"&&K.name!==undefined){G.name=K.name.substring(0,140)}else{if(typeof e==="string"){G.name=e.substring(0,140)}else{throw"Cannot register a client without a name. No name is stored and no name was passed to registerClient()"}}}}I=function(P){if(typeof P!=="object"||P.id===undefined||P.name===undefined){throw"Could not confirm registration of the client. An unexpected error occured."}var O={name:P.name,id:P.id},N;if(K.id!==undefined&&K.secret!==undefined){O.secret=K.secret;var M=new jsSHA("SHA-256","TEXT");M.update("swdapi"+G.salt+G.id+K.secret);N=M.getHash("HEX");if(P.signature===undefined||N!==P.signature){throw"Failed to confirm the client id. The signature returned by the server doesn't match ours. This should be impossible without a man in the middle."}}else{if(P.secret!==undefined){O.secret=P.secret}else{throw"Failed to register client: no secret returned by server."}}x(O);console.log("New client registered successfully: "+O.name);if(typeof L==="function"){L()}};console.log("Registering client with server.");d("swdapi/registerClient",G,I,function(M){if(typeof M!=="object"||M["SWDAPI-Error"]===undefined||[400014,403002,403004].indexOf(parseInt(M["SWDAPI-Error"].code))===-1){throw"Could not register the client. An unexpected error occured."}console.log("The client id-secret pair stored on this device has either expired or is corrupt. Requesting a new one.");delete K.id;delete K.secret;x({name:G.name});G={name:G.name,salt:j()};d("swdapi/registerClient",G,I,function(){throw"Could not register the client. A very unexpected error occured."})})}function i(){if(!p("localStorage")){throw"Unable to access localStorage API. You must define your own fetchClientData and storeClientData handlers."}var G={};if(window.localStorage.getItem("client-id")!==null){G.id=window.localStorage.getItem("client-id")}if(window.localStorage.getItem("client-secret")!==null){G.secret=window.localStorage.getItem("client-secret")}if(window.localStorage.getItem("client-name")!==null){G.name=window.localStorage.getItem("client-name")}return G}function o(G){if(!p("localStorage")){throw"Unable to access localStorage API. You must define your own fetchClientData and storeClientData handlers."}if(G.id!==undefined){window.localStorage.setItem("client-id",G.id)}else{window.localStorage.removeItem("client-id")}if(G.secret!==undefined){window.localStorage.setItem("client-secret",G.secret)}else{window.localStorage.removeItem("client-secret")}if(G.name!==undefined){window.localStorage.setItem("client-name",G.name)}else{window.localStorage.removeItem("client-name")}return true}function p(H){try{var J=window[H],G="__storage_test__";J.setItem(G,G);J.removeItem(G);return true}catch(I){return false}}function d(N,K,H,M,J){J=s(J,l);H=s(H,null);M=s(M,null);var I=new XMLHttpRequest(),L=null,G=5;if(J!==null&&A(J)!==true){throw"The authentication token you passed is in an invalid format. Request not sent."}L=B(N,K,J);I.open("POST",g);I.setRequestHeader("Content-Type","application/json;charset=UTF-8");I.onreadystatechange=function(){if(I.readyState!==I.DONE){return}var O=(I.getResponseHeader("content-type")==="application/json"?JSON.parse(I.responseText):I.responseText);if(I.status===200){if(typeof H==="function"){H(O,I.status,N,K,(J===null?null:J.id))}return true}G-=1;if(G>0){if(typeof O!=="string"&&O["SWDAPI-Error"]!==undefined&&O["SWDAPI-Error"]["code"]!==undefined&&N!=="swdapi/validateAuthToken"){var P=O["SWDAPI-Error"]["code"];if(P>=400006&&P<=400009){console.log("Request failed due to expiry data. Reseting system time offset and trying again.");D(I.getResponseHeader("date"))}else{if(P==400014||P==403002){console.log("SWDAPI: An api request to '"+N+"' failed because the server reported that the request's signature was invalid. This could be because the client id-secret pair you are using is invalid or has expired, the authentication token you are using has expired or is invalid, or some other secret information embeded in the signature has changed on the server. ");G=0;if(C===true&&N!=="swdapi/registerClient"){console.log("Attemping to automatically re-register the client using the original name.");var Q=k();x({name:Q.name});l=b(null);u()}else{console.log("Auto re-registering the client is disabled. Please contact support. Clearing you browser cache and localStorage container will fix this problem but will require you to reauthenticate.")}}else{G=0}}}else{G=0}}if(G>0){d(N,K,H,M,J)}else{if(typeof M==="function"){M(O,I.status,N,K,(J===null?null:J.id))}else{throw [O,I.status,N,K,(J===null?null:J.id)]}}};I.send(JSON.stringify({method:N,meta:L,data:K}));return true}function n(G,H){if(["defaultToken"].indexOf(G)===-1){throw"addListener: Invalid event type"}if(typeof H!=="function"){throw"addListener: Callback isn't a function"}if(v[G].indexOf(H)!==-1){return true}v[G].push(H);return true}function h(G,H){if(["defaultToken"].indexOf(G)===-1){throw"addListener: Invalid event type"}if(v[G].indexOf(H)===-1){return false}v[G].splice(v[G].indexOf(H),1);return true}function c(H,G){if(typeof v[H]!=="object"){return false}for(var I in v[H]){if(v[H].hasOwnProperty(I)&&typeof v[H][I]==="function"){v[H][I](G)}}return true}function D(H){var I=new Date(H),G=I.getTime()-Date.now();console.log("Stored server clock offset: "+G+"ms (previously "+q+"ms)");q=G}function r(){return new Date(Date.now()+q)}function j(){return(Math.random().toString(36)+"00000000000000000").slice(2,10+2)}};